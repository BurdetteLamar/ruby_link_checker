#!/usr/bin/env ruby

require 'optparse'
require_relative '../lib/ruby_link_checker'

parser = OptionParser.new

parser.banner = <<-EOF
Usage: #{$0} [options]

  - Checks links in the Ruby HTML documentation found at #{RubyLinkChecker::BASE_URL}.

  - Writes an HTML file that reports:

    - Onsite pages found.
    - Broken links in onsite pages (including both page not found and fragment not found).
    - Offsite pages found.

  The report is an HTML file located in the directory
  given by option --dirpath (default is './ruby_link_checker'),
  and whose filename is given by option --report-filename (default is a timestamped name).

  By default, reads the documentation pages and writes the report, also creating
  a JSON "stash" file in the directory given by option --dirpath (as above),
  and whose filename is given by option --stash-filename (default is a timestamped name).
  
  You can limit the result to one or the other -- report or stash -- via options:

  - Option --stash-only specifies that the documentation is to be read
    and the stash file written; the report is not to be written.
  - Option --report-only specifies that documentation is not to be read
    and the stash file is not to be written;  the report is to be based
    on the most recent stash file.

  These options are mainly for development and debugging;  work on the reporting
  code may not need a fresh stash file for each report.

  Option --verbosity may also be useful for development and debugging.
  Setting the verbosity to verbose tells the link checker to print a lot
  of progess messages.

  Finally, option --forgive may be used to suppress unwanted information
  about broken links.  In particular, the Ruby team has determined that
  broken links on the NEWS and LEGAL pages should not be fixes, and therefore
  perhaps should not be reported.

EOF
parser.on(
  '--dirpath DIRPATH',
  'Path to directory containing stashes and reports.',
  '    The default is ./ruby_link_checker.'
)

parser.on(
  '--stash-filename FILENAME',
  'Name of JSON stash file.',
  '    The default is a timestamped filename',
  '    (e.g., 2026-02-04-Wed-18:47:24Z.json).'
)

parser.on(
  '--report-filename FILENAME',
  'Name of HTML report file.',
  '    The default is a timestamped filename',
  '    (e.g., 2026-02-04-Wed-18:47:24Z.html)'
)

parser.on(
  '--stash-only',
  'Read Ruby documents and write new stash;',
  '    do not create new report.'
)

parser.on(
  '--report-only',
  'Read existing stash and write new report;',
  '    do not read Ruby documents or write new stash.'
)

parser.on(
  '--forgive PATTERN',
  'Do not report broken links on pages matching the pattern.',
  '    May be given more than once.'
)

parser.on(
  '--verbosity LEVEL',
  'Set verbosity level to one of:',
  '    quiet: Print no progress messages.',
  '    normal: (default) Print some progress messages',
  '    debug: Print extensive progress messages.'
)

parser.on(
  '--version',
  'Print the version and exit.',
) do
  puts RubyLinkChecker::VERSION
  exit
end

options = {
  'dirpath' => nil,
  'report-filename' => nil,
  'stash-filename' => nil,
  'stash-only' => false,
  'report-only' => false,
  'quiet' => false,
}

parser.parse!(into: options)
p options
