#!/usr/bin/env ruby

require 'optparse'
require_relative '../lib/ruby_link_checker'

parser = OptionParser.new

parser.banner = <<-EOF

Usage: #{$0} [options]

  - Reads Ruby HTML documentation found at #{RubyLinkChecker::BASE_URL}.

  - Writes a JSON "stash" file containing its findings.
  - Writes an HTML report file that lists:

    - Onsite pages found.
    - Broken links in onsite pages (including both pages not found and fragments not found).
    - Offsite pages found.

  The link checker creates a new subdirectory in directory ./ruby_link_checker
  whose name is timestamp-based (e/g/. 2026-02-11-Wed-21.29.00+0000),
  and writes output files stash.json and report.html into that subdirectory.

  Option --verbosity controls the quantity of progress messages to be printed.
  The default value is 'moderate'; value 'quiet' suppresses progress messages.

  Option --check-news specifies that paths and fragments
  on NEWS pages are to be checked. By default, these are not checked,
  because the Ruby core team has determined that the underlying NEWS
  pages are historical in nature and should not be modified.

  Option --check-github-lines specifies that line-number fragments on GitHub pages
  is to be reported as not-found. By default, this is not reported.

  Option --help causes the link checker to print its help text, then exit.

  Option --version causes the link checker to print its version, then exit.

  Option --report-only specifies that the documentation on the website
  is not to be re-read and that a new stash file is not to be written;
  instead, the report is to be based on the most recent stash file.
  This may be useful in developing or debugging the reporting code
  (avoids repeating the long reading and stashing process).

  Option --open-report specifies that the generated HTML report
  is to be opened in a web browser.

  Option --verbosity may also be useful for development and debugging.
  Setting the verbosity value to 'debug' tells the link checker to print
  all its progress messages.

EOF

options = {
  check_github_lines: false,
  check_news: false,
  report_only: false,
  open_report: false,
  verbosity: 'minimal',
}

parser.on(
  '--check-github-lines',
  'Report line-number fragments on GitHub pages.',
  )  do |arg|
  options[:check_github_lines] = true
end

parser.on(
  '--check-news',
  'Check paths and fragments on NEWS pages.',
  ) do
  options[:check_news] = true
end

parser.on(
  '--open-report',
  'Open the HTML report in a browser.'
) do
  options[:open_report] = true
end

parser.on(
  '--report-only',
  'Read recent stash and write new report;',
  '    do not re-read Ruby documents or write new stash.'
) do
  options[:report_only] = true
end

parser.on(
  '--verbosity LEVEL',
  'Set verbosity level to one of:',
  '    quiet: Print no progress messages.',
  '    minimal: (default) Print some progress messages',
  '    debug: Print extensive progress messages.'
) do |arg|
  options[:verbosity] = arg
end

parser.on(
  '--version',
  'Print the version and exit.',
) do
  puts RubyLinkChecker::VERSION
  exit
end

parser.parse!
report_only = options.delete(:report_only)
open_report = options.delete(:open_report)
checker = RubyLinkChecker.new
checker.create_stash unless report_only
report_filepath = checker.create_report(options)
if open_report
  command = "start #{report_filepath}"
  system(command)
end
