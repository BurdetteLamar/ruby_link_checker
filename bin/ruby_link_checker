#!/usr/bin/env ruby

require 'optparse'
require_relative '../lib/ruby_link_checker'

parser = OptionParser.new

parser.banner = <<-EOF

Usage: #{$0} [options]

  - Checks links in the Ruby HTML documentation found at #{RubyLinkChecker::BASE_URL}.

  - Writes an HTML file that reports:

    - Onsite pages found.
    - Broken links in onsite pages (including both page not found and fragment not found).
    - Offsite pages found.

  The Report

  The report is an HTML file located in the directory
  given by option --dirpath (default is './ruby_link_checker'),
  and whose filename is given by option --report-filename (default is a timestamped name).

  User Options

  Option --verbosity controls the quantity of progress messages to be printed.
  The default value is 'minimal'; value 'quiet' suppresses progress messages.

  Option --

  Options --report-news and --report-legal specify that broken links
  on NEWS and LEGAL pages are to be reported. By default, these are not reported,
  because the Ruby core team has determined that the underlying NEWS and LEGAL
  pages are historical in nature and should not be modified.

  Option --report-github-lines specifies that a line-number fragment on a GitHub page
  is to be reported as not-found. By default, this is not reported.

  Option --help causes the link checker to print its help text, then exit.

  Option --version causes the link checker to print its version, then exit.

  Developer Options

  Some options may be of use in developing or debugging the link checker.

  By default, reads the documentation pages and writes the report, also creating
  a JSON "stash" file in the directory given by option --dirpath (as above),
  and whose filename is given by option --stash-filename (default is a timestamped name).
  
  You can limit the result to one or the other -- report or stash -- via options:

  - Option --stash-only specifies that the documentation is to be read
    and the stash file written; the report is not to be written.
  - Option --report-only specifies that documentation is not to be read
    and the stash file is not to be written;  the report is to be based
    on the most recent stash file.

  Option --verbosity may also be useful for development and debugging.
  Setting the verbosity value to 'debug' tells the link checker to print
  all its progress messages.

EOF

options = {
  'dirpath' => nil,
  'report-filename' => nil,
  'stash-filename' => nil,
  'stash-only' => false,
  'report-only' => false,
  'verbosity' => 'minimal',
  'report-github-lines' => false,
  'report-legal' => false,
  'report-news' => false,
}

parser.separator('Basic Options')

parser.on(
  '--dirpath DIRPATH',
  'Path to directory containing stashes and reports.',
  '    The default is ./ruby_link_checker.'
) do |arg|
  options['dirpath'] = arg
end

parser.on(
  '--stash-filename FILENAME',
  'Name of JSON stash file.',
  '    The default is a timestamped filename',
  '    (e.g., 2026-02-04-Wed-18:47:24Z.json).'
) do |arg|
  options['stash-filename'] = arg
end

parser.on(
  '--report-filename FILENAME',
  'Name of HTML report file.',
  '    The default is a timestamped filename',
  '    (e.g., 2026-02-04-Wed-18:47:24Z.html)'
) do |arg|
  options['report-filename'] = arg
end

parser.on(
  '--report-github-lines',
  'Report line-number fragments on GitHub pages.',
  )  do |arg|
  options['report-github-lines'] = arg
end

parser.on(
  '--report-legal',
  'Report broken links on LEGAL pages.',
  ) do
  options['report-legal'] = true
end

parser.on(
  '--report-news',
  'Report broken links on NEWS pages.',
  ) do
  options['report-news'] = true
end

parser.separator('Developer Options')

parser.on(
  '--stash-only',
  'Read Ruby documents and write new stash;',
  '    do not create new report.'
) do
  options['stash-only'] = true
end

parser.on(
  '--report-only',
  'Read existing stash and write new report;',
  '    do not read Ruby documents or write new stash.'
) do
  options['report-only'] = true
end

parser.on(
  '--verbosity LEVEL',
  'Set verbosity level to one of:',
  '    quiet: Print no progress messages.',
  '    minimal: (default) Print some progress messages',
  '    debug: Print extensive progress messages.'
) do |arg|
  options['verbosity'] = arg
end

parser.on(
  '--version',
  'Print the version and exit.',
) do
  puts RubyLinkChecker::VERSION
  exit
end

parser.parse!
p options
